#!/usr/bin/env node

const fs = require('fs');
const path = require('path');

/**
 * Generate CodeSnippets.purs from example source files
 *
 * Reads full source code from each example file and embeds it
 * in a PureScript module for display on the website.
 */

const PROJECT_ROOT = path.resolve(__dirname, '..');
const DEMO_SRC = path.join(PROJECT_ROOT, 'demo-website', 'src');
const OUTPUT_FILE = path.join(DEMO_SRC, 'HTML', 'CodeSnippets.purs');

// Map snippet names to source files
const SNIPPETS = {
  // Basic examples
  'threeLittleCircles': 'Viz/TreeAPI/ThreeLittleCircles.purs',
  'threeLittleCirclesTransition': 'Viz/TreeAPI/ThreeLittleCirclesTransition.purs',
  'simpleTree': 'Viz/TreeAPI/SimpleTreeExample.purs',
  'nestedElements': 'Viz/TreeAPI/NestedElementsExample.purs',
  'threeLittleDimensions': 'Viz/TreeAPI/ThreeLittleDimensionsExample.purs',

  // Charts
  'barChart': 'Viz/TreeAPI/BarChartExample.purs',
  'scatterPlot': 'Viz/TreeAPI/ScatterPlotExample.purs',
  'lineChart': 'Viz/TreeAPI/LineChartExample.purs',
  'groupedBarChart': 'Viz/TreeAPI/GroupedBarChartExample.purs',
  'multiLineChart': 'Viz/TreeAPI/MultiLineChartExample.purs',
  'radialStackedBar': 'Viz/TreeAPI/RadialStackedBarExample.purs',
  'anscombesQuartet': 'Viz/TreeAPI/AnscombesQuartet.purs',
  'wealthHealth': 'Viz/TreeAPI/WealthHealthDraw.purs',
  'splom': 'Viz/SPLOM/SPLOM.purs',

  // Hierarchies
  'treeViz': 'Viz/TreeAPI/TreeViz.purs',
  'radialTree': 'Viz/TreeAPI/RadialTreeViz.purs',
  'horizontalTree': 'Viz/TreeAPI/HorizontalTreeViz.purs',
  'cluster': 'Viz/TreeAPI/ClusterViz.purs',
  'treemap': 'Viz/TreeAPI/TreemapViz.purs',
  'sunburst': 'Viz/TreeAPI/SunburstViz.purs',
  'pack': 'Viz/TreeAPI/PackViz.purs',
  'partition': 'Viz/TreeAPI/PartitionViz.purs',
  'animatedTreeCluster': 'Viz/TreeAPI/AnimatedTreeCluster.purs',

  // Relational
  'sankey': 'Viz/TreeAPI/SankeyDiagram.purs',
  'chord': 'Viz/TreeAPI/ChordDiagram.purs',
  'edgeBundle': 'Viz/TreeAPI/EdgeBundleViz.purs',

  // Force-directed
  'simpleForce': 'Viz/SimpleForceGraph.purs',
  'lesMis': 'Viz/LesMisV3/Draw.purs',

  // v3 DSL demos
  'v3Parabola': 'Viz/TreeAPI/V3ParabolaDemo.purs',
  'v3Transition': 'Viz/TreeAPI/V3TransitionDemo.purs',
  'v3GUP': 'Viz/TreeAPI/V3GUPDemo.purs',
};

function escapeForPureScript(content) {
  return content
    .replace(/\\/g, '\\\\')   // Escape backslashes first
    .replace(/"/g, '\\"')      // Escape double quotes
    .replace(/\n/g, '\\n')     // Escape newlines
    .replace(/\r/g, '\\r')     // Escape carriage returns
    .replace(/\t/g, '\\t');    // Escape tabs
}

function generateModule() {
  const snippetData = [];

  for (const [name, relativePath] of Object.entries(SNIPPETS)) {
    const fullPath = path.join(DEMO_SRC, relativePath);

    if (!fs.existsSync(fullPath)) {
      console.warn(`Warning: Source file not found: ${relativePath}`);
      continue;
    }

    const content = fs.readFileSync(fullPath, 'utf8');
    const lineCount = content.split('\n').length;
    snippetData.push({
      name,
      source: `demo-website/src/${relativePath}`,
      content: escapeForPureScript(content),
      lines: `1-${lineCount}`
    });

    console.log(`  + ${name} (${relativePath}, ${lineCount} lines)`);
  }

  // Generate the constants
  const constants = snippetData.map(s =>
    `snippet_${s.name}_content :: String\nsnippet_${s.name}_content = "${s.content}"`
  ).join('\n\n');

  // Generate the lookup function
  const lookupCases = snippetData.map(s =>
    `  "${s.name}" -> snippet_${s.name}_content`
  ).join('\n');

  // Generate snippet info lookup
  const infoCases = snippetData.map(s =>
    `  "${s.name}" ->\n    { name: "${s.name}"\n    , content: snippet_${s.name}_content\n    , source: "${s.source}"\n    , lines: "${s.lines}"\n    }`
  ).join('\n');

  const moduleContent = `-- | Auto-generated module containing code snippets
-- | Generated by scripts/generate-code-snippets.js
-- | DO NOT EDIT THIS FILE MANUALLY
module CodeSnippets where

import Prelude

-- | Snippet metadata
type SnippetInfo =
  { name :: String
  , content :: String
  , source :: String
  , lines :: String
  }

-- ** Snippet Content Constants **

${constants}

-- | Look up a snippet by name
getSnippet :: String -> String
getSnippet name = case name of
${lookupCases}
  _ -> "Snippet not found: " <> name

-- | Get snippet info by name
getSnippetInfo :: String -> SnippetInfo
getSnippetInfo name = case name of
${infoCases}
  _ ->
    { name: "not-found"
    , content: "Snippet not found: " <> name
    , source: ""
    , lines: "1-1"
    }
`;

  return moduleContent;
}

console.log('Generating CodeSnippets.purs...');
const content = generateModule();
fs.writeFileSync(OUTPUT_FILE, content);
console.log(`\nGenerated ${OUTPUT_FILE}`);
