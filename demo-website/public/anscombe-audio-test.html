<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéµ Anscombe's Quartet - Audio Sonification</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            line-height: 1.6;
            color: #2c3e50;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        .intro {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .stats-highlight {
            background: #fff3cd;
            padding: 15px;
            border-left: 4px solid #ffc107;
            margin: 20px 0;
        }
        .datasets-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 30px 0;
        }
        .dataset-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border: 2px solid #dee2e6;
        }
        .dataset-card h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        .dataset-card.playing {
            border-color: #e74c3c;
            background: #fff5f5;
            animation: pulse 0.5s ease-in-out;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        button {
            width: 100%;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }
        button.dataset-a { background: #3498db; color: white; }
        button.dataset-b { background: #2ecc71; color: white; }
        button.dataset-c { background: #e74c3c; color: white; }
        button.dataset-d { background: #f39c12; color: white; }
        button.playing {
            background: #95a5a6 !important;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            margin-top: 15px;
        }
        th, td {
            padding: 6px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #34495e;
            color: white;
            font-weight: 600;
        }
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        .description {
            font-size: 14px;
            color: #7f8c8d;
            margin: 10px 0;
            font-style: italic;
        }
        #globalStatus {
            margin: 20px 0;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
        }
        .mapping-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
        code {
            background: #2c3e50;
            color: #e74c3c;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <h1>üéµ Anscombe's Quartet - Audio Sonification</h1>

    <div class="intro">
        <h2>Why This Matters</h2>
        <p><strong>Anscombe's Quartet</strong> is a famous demonstration of why visualization matters. These four datasets have:</p>
        <div class="stats-highlight">
            <strong>Identical Statistics:</strong><br>
            ‚Ä¢ Same mean of x (9.0)<br>
            ‚Ä¢ Same mean of y (7.5)<br>
            ‚Ä¢ Same variance<br>
            ‚Ä¢ Same correlation (0.816)<br>
            ‚Ä¢ Same linear regression line
        </div>
        <p>But when <strong>visualized</strong>, they look completely different. And when <strong>sonified</strong>, they <em>sound</em> completely different!</p>
        <p>Each dataset plays as a looping <strong>arpeggiation</strong> - the pattern repeats with short pauses so you can hear the "shape" of the data aurally, just as you would see it visually. This demonstrates that the Finally Tagless pattern works not just for visual ‚Üí audio, but reveals hidden patterns that statistics alone cannot show.</p>
    </div>

    <div class="mapping-info">
        <h3>üéº Audio Mappings</h3>
        <p>Each point (x, y) is mapped to sound as follows:</p>
        <ul>
            <li><strong>x value</strong> ‚Üí Time (when the note plays)</li>
            <li><strong>y value</strong> ‚Üí Pitch (frequency: 200 + y * 50 Hz)</li>
            <li><strong>y value</strong> ‚Üí Volume (amplitude: y / 15)</li>
            <li>All notes use a <strong>sine wave</strong> (pure tone) for 0.3 seconds</li>
        </ul>
    </div>

    <div id="globalStatus">üîä Click any dataset to start looping arpeggiation (click again to stop)</div>

    <div class="datasets-grid">
        <!-- Dataset A -->
        <div class="dataset-card" id="card-a">
            <h3>Dataset A</h3>
            <p class="description">Linear progression - smooth ascending/descending melody</p>
            <button class="dataset-a" id="btn-a" onclick="toggleDataset('A')">
                ‚ñ∂Ô∏è Start Dataset A
            </button>
            <table id="table-a"></table>
        </div>

        <!-- Dataset B -->
        <div class="dataset-card" id="card-b">
            <h3>Dataset B</h3>
            <p class="description">Parabolic curve - melodic arc with clear turning point</p>
            <button class="dataset-b" id="btn-b" onclick="toggleDataset('B')">
                ‚ñ∂Ô∏è Start Dataset B
            </button>
            <table id="table-b"></table>
        </div>

        <!-- Dataset C -->
        <div class="dataset-card" id="card-c">
            <h3>Dataset C</h3>
            <p class="description">Linear with outlier - melody interrupted by jarring note</p>
            <button class="dataset-c" id="btn-c" onclick="toggleDataset('C')">
                ‚ñ∂Ô∏è Start Dataset C
            </button>
            <table id="table-c"></table>
        </div>

        <!-- Dataset D -->
        <div class="dataset-card" id="card-d">
            <h3>Dataset D</h3>
            <p class="description">Vertical line with outlier - repeated note with one exception</p>
            <button class="dataset-d" id="btn-d" onclick="toggleDataset('D')">
                ‚ñ∂Ô∏è Start Dataset D
            </button>
            <table id="table-d"></table>
        </div>
    </div>

    <script>
        // Anscombe's Quartet datasets
        const datasets = {
            A: [
                { x: 10.0, y: 8.04 }, { x: 8.0, y: 6.95 }, { x: 13.0, y: 7.58 },
                { x: 9.0, y: 8.81 }, { x: 11.0, y: 8.33 }, { x: 14.0, y: 9.96 },
                { x: 6.0, y: 7.24 }, { x: 4.0, y: 4.26 }, { x: 12.0, y: 10.84 },
                { x: 7.0, y: 4.82 }, { x: 5.0, y: 5.68 }
            ],
            B: [
                { x: 10.0, y: 9.14 }, { x: 8.0, y: 8.14 }, { x: 13.0, y: 8.74 },
                { x: 9.0, y: 8.77 }, { x: 11.0, y: 9.26 }, { x: 14.0, y: 8.10 },
                { x: 6.0, y: 6.13 }, { x: 4.0, y: 3.10 }, { x: 12.0, y: 9.13 },
                { x: 7.0, y: 7.26 }, { x: 5.0, y: 4.74 }
            ],
            C: [
                { x: 10.0, y: 7.46 }, { x: 8.0, y: 6.77 }, { x: 13.0, y: 12.74 },
                { x: 9.0, y: 7.11 }, { x: 11.0, y: 7.81 }, { x: 14.0, y: 8.84 },
                { x: 6.0, y: 6.08 }, { x: 4.0, y: 5.39 }, { x: 12.0, y: 8.15 },
                { x: 7.0, y: 6.42 }, { x: 5.0, y: 5.73 }
            ],
            D: [
                { x: 8.0, y: 6.58 }, { x: 8.0, y: 5.76 }, { x: 8.0, y: 7.71 },
                { x: 8.0, y: 8.84 }, { x: 8.0, y: 8.47 }, { x: 8.0, y: 7.04 },
                { x: 8.0, y: 5.25 }, { x: 19.0, y: 12.50 }, { x: 8.0, y: 5.56 },
                { x: 8.0, y: 7.91 }, { x: 8.0, y: 6.89 }
            ]
        };

        let audioContext = null;
        let currentlyPlaying = null;
        let loopIntervalId = null;
        let scheduledNodes = [];

        // Initialize tables
        function renderTable(datasetName, data) {
            const table = document.getElementById(`table-${datasetName.toLowerCase()}`);
            const sortedData = [...data].sort((a, b) => a.x - b.x);

            let html = '<thead><tr><th>x</th><th>y</th></tr></thead><tbody>';
            sortedData.forEach(point => {
                html += `<tr><td>${point.x.toFixed(1)}</td><td>${point.y.toFixed(2)}</td></tr>`;
            });
            html += '</tbody>';
            table.innerHTML = html;
        }

        // Render all tables
        Object.keys(datasets).forEach(name => renderTable(name, datasets[name]));

        function updateStatus(message) {
            document.getElementById('globalStatus').textContent = message;
        }

        function stopAllPlayback() {
            if (loopIntervalId) {
                clearInterval(loopIntervalId);
                loopIntervalId = null;
            }

            // Stop all scheduled audio nodes
            scheduledNodes.forEach(node => {
                try {
                    node.stop();
                    node.disconnect();
                } catch (e) {
                    // Already stopped
                }
            });
            scheduledNodes = [];

            // Reset all buttons and cards
            ['A', 'B', 'C', 'D'].forEach(name => {
                const btn = document.getElementById(`btn-${name.toLowerCase()}`);
                const card = document.getElementById(`card-${name.toLowerCase()}`);
                btn.textContent = `‚ñ∂Ô∏è Start Dataset ${name}`;
                btn.classList.remove('playing');
                card.classList.remove('playing');
            });

            currentlyPlaying = null;
        }

        function toggleDataset(datasetName) {
            const btn = document.getElementById(`btn-${datasetName.toLowerCase()}`);
            const card = document.getElementById(`card-${datasetName.toLowerCase()}`);

            // If this dataset is playing, stop it
            if (currentlyPlaying === datasetName) {
                stopAllPlayback();
                updateStatus('üîä Stopped. Click any dataset to start arpeggiation');
                return;
            }

            // Stop whatever is playing
            stopAllPlayback();

            try {
                // Create audio context if needed
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                currentlyPlaying = datasetName;
                card.classList.add('playing');
                btn.classList.add('playing');
                btn.textContent = `‚èπÔ∏è Stop Dataset ${datasetName}`;

                updateStatus(`üéµ Arpeggiation Dataset ${datasetName} (looping)... Listen for the pattern!`);

                const data = datasets[datasetName];
                const sortedData = [...data].sort((a, b) => a.x - b.x);

                // Play one cycle of the arpeggio
                function playOneCycle() {
                    sortedData.forEach((point, i) => {
                        const time = i * 0.175;                    // 175ms between notes (2x faster)
                        const frequency = 200.0 + (point.y * 50.0); // 200-700 Hz range
                        const duration = 0.15;                      // Shorter duration for faster tempo
                        const volume = Math.min(0.5, point.y / 15.0); // Scale volume by y

                        const node = scheduleNote(audioContext, {
                            time,
                            frequency,
                            duration,
                            volume,
                            waveform: 'sine'
                        });
                        scheduledNodes.push(node);
                    });
                }

                // Play immediately
                playOneCycle();

                // Then loop with pause between cycles
                const cycleTime = (sortedData.length * 0.175) + 0.4; // Arpeggio + 400ms pause
                loopIntervalId = setInterval(() => {
                    // Clean up old nodes
                    scheduledNodes = scheduledNodes.filter(node => {
                        try {
                            // If node is still connected, keep it
                            return true;
                        } catch (e) {
                            return false;
                        }
                    });
                    playOneCycle();
                }, cycleTime * 1000);

            } catch (err) {
                updateStatus(`‚ùå Error: ${err.message}`);
                console.error(err);
                stopAllPlayback();
            }
        }

        function scheduleNote(ctx, params) {
            const now = ctx.currentTime;
            const startTime = now + params.time;
            const stopTime = startTime + params.duration;

            const oscillator = ctx.createOscillator();
            oscillator.type = params.waveform;
            oscillator.frequency.setValueAtTime(params.frequency, startTime);

            const gainNode = ctx.createGain();
            gainNode.gain.setValueAtTime(params.volume, startTime);

            const fadeOutStart = stopTime - 0.01;
            gainNode.gain.setValueAtTime(params.volume, fadeOutStart);
            gainNode.gain.linearRampToValueAtTime(0.0, stopTime);

            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);

            oscillator.start(startTime);
            oscillator.stop(stopTime);

            oscillator.onended = () => {
                oscillator.disconnect();
                gainNode.disconnect();
            };

            return oscillator; // Return for tracking
        }
    </script>
</body>
</html>
