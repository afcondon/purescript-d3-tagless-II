# Code Explorer V4 - Project Specification

## Vision

"Shock and awe" demo of the PSD3 library's capabilities, showcasing potential real use-cases for hybrid data-visualization/user-interface. The primary use-case is **at-a-glance understanding and exploration of a large codebase**.

## Design Principles

1. **Library showcase** - All visualization logic uses `psd3-selection` and `psd3-simulation` APIs. No custom JavaScript in the demo; if functionality is missing, add it to the library.

2. **Declarative scenes** - Explorable/manipulable scenes that transition from one to another via a declarative `SceneConfig` + `TransitionMatrix` system.

3. **Progressive disclosure** - Start with overview, drill down to detail. Each scene reveals more specific information.

4. **Data-agnostic architecture** - While we develop against our own codebase, the design should work with any codebase (PureScript, Haskell, etc.) via pluggable data adapters.

## Scenes

### Scene 1: Orbital Overview

**Purpose**: Show package structure and relative sizes at a glance.

**Layout**:
- Packages arranged on an outer orbital ring (radial force)
- Modules clustered around their parent package (cluster forces)
- Circle sizes represent LOC or complexity

**Interactions**:
- Hover: Highlight package and its modules
- Click package: Filter to just that package's modules
- Drag: Rearrange nodes

**Forces**:
- `forceRadial` - Packages on outer ring
- `forceX`/`forceY` with accessor - Modules toward parent package
- `forceCollide` - Prevent overlap

### Scene 2: Dependency Tree

**Purpose**: Show the module dependency hierarchy rooted at a focal module (e.g., `PSD3.Main`).

**Transition from Scene 1**:
1. Staggered radial tree animation (layers appear in sequence)
2. Curved bezier links draw as nodes arrive
3. Pause to show tree structure
4. Links straighten, nodes unpin
5. Force simulation engages → organic tree layout

**Layout** (post-transition):
- Force-directed tree using D3's recipe:
  - `forceLink(distance: 0, strength: 1)` - Tight links
  - `forceManyBody(strength: -50)` - Gentle repulsion
  - `forceX(0)` + `forceY(0)` - Centering

**Interactions**:
- Hover: Highlight upstream (dependencies) and downstream (dependents)
- Click node: Filter to subgraph (upstream + downstream only)
- Drag: Standard force layout dragging

### Scene 3: Bubblepack Detail

**Purpose**: Show internal structure of modules - types, classes, instances, functions.

**Transition from Scene 2**:
- Clicked/selected nodes expand from circles to bubblepack containers
- Internal elements (colored circles) appear grouped by category

**Layout**:
- Each module is a containing circle (pack layout)
- Internal circles represent:
  - Type definitions (color A)
  - Foreign definitions (color B)
  - Type classes (color C)
  - Instances (color D)
  - Functions (color E)

**Interactions**:
- Hover internal circle: Show dependencies on this specific type/function
- Click internal circle: Filter to just its direct dependencies

## Data Model

### Current Phase (File-based)

Data generated by build scripts, served as static JSON:
- `modules.json` - Module metadata (name, package, LOC, etc.)
- `dependencies.json` - Module-to-module dependencies
- `internals.json` - Per-module type/function definitions

### Future Phase (Database-backed)

Query server for temporal data:
- Git history, commit timelines
- Issue correlations
- "Gource-style" animations
- Multi-codebase support

## Architecture

```
ce-website/
├── SPEC.md              # This file
├── spago.yaml           # Package config
├── src/
│   ├── Main.purs        # Entry point
│   ├── Types.purs       # Core data types
│   ├── Data/
│   │   └── Loader.purs  # JSON loading
│   ├── Scene/
│   │   ├── Types.purs   # SceneConfig, TransitionMatrix
│   │   ├── Orbit.purs   # Scene 1 config
│   │   ├── Tree.purs    # Scene 2 config
│   │   └── Bubblepack.purs  # Scene 3 config
│   ├── Render/
│   │   ├── Nodes.purs   # Node rendering
│   │   ├── Links.purs   # Link rendering
│   │   └── DOM.purs     # SVG structure
│   └── Interaction/
│       ├── Hover.purs   # Hover highlighting
│       ├── Click.purs   # Click filtering
│       └── Drag.purs    # Drag handling
├── public/
│   ├── index.html
│   ├── styles.css
│   └── bundle.js        # Built output
├── data/
│   └── *.json           # Generated data files
└── assets/
    └── ...              # Images, fonts, etc.
```

## Library Requirements

Forces needed from `psd3-simulation`:

| Force | Current Status | Needed |
|-------|----------------|--------|
| `forceManyBody` | ✅ Available | - |
| `forceManyBody` (filtered) | ✅ Available | `createManyBodyFiltered` in Core |
| `forceCollide` | ✅ Available (fixed radius) | - |
| `forceCollide` (dynamic) | ✅ Available | `createCollideDynamic` with `(node -> Number)` accessor |
| `forceLink` | ✅ Available | - |
| `forceCenter` | ✅ Available | - |
| `forceX` / `forceY` | ✅ Available (fixed target) | - |
| `forceX` / `forceY` (dynamic) | ✅ Available | `createForceXDynamic`/`createForceYDynamic` |
| `forceRadial` | ✅ Available | - |
| `forceRadial` (filtered) | ✅ Available | `createRadialFiltered` in Core |

Selection API needed from `psd3-selection`:
- General Update Pattern (GUP) - ✅ Available
- Transitions - ✅ Available (basic)
- Tick-driven transitions - ✅ Available via `PSD3.Transition.Tick` (recommended for simulations)
- Staggered transitions - ✅ Achievable via `startProgressFrom` with offset values

## Development Phases

### Phase 1: Foundation
- [ ] Set up ce-website subrepo
- [ ] Add missing force variants to library
- [ ] Create basic data loader
- [ ] Implement minimal Scene 1 (orbit)

### Phase 2: Tree Scene
- [ ] Implement Scene 2 force config
- [ ] Build transition from Scene 1 → 2
- [ ] Add hover highlighting

### Phase 3: Bubblepack
- [ ] Implement Scene 3 with pack layout
- [ ] Build transition from Scene 2 → 3
- [ ] Add internal element interactions

### Phase 4: Polish
- [ ] Refine animations and transitions
- [ ] Add keyboard navigation
- [ ] Performance optimization
- [ ] Documentation
